<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mini Chicken Invaders Mobile</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{
  margin:0;
  background:#000;
  color:white;
  font-family:Arial;
  text-align:center;
  overflow:hidden;
}

#game{
  position:relative;
  width:100vw;
  height:75vh;
  margin-top:10px;
  border:2px solid white;
  background:#6f6d6d;
  overflow:hidden;
}

.player{
  position:absolute;
  bottom:80px;
  left:50%;
  transform:translateX(-50%);
  width:100px;  /* player pi√π grande */
  height:100px;
  border-radius:10px;
  overflow:hidden;
}

.player img{
  width:100%;
  height:100%;
  object-fit:contain;
  border-radius:10px;
}

.bullet {
  position: absolute;
  font-size: 36px; /* missile pi√π grande */
  user-select: none;
}

.enemy {
  width:80px;  /* nemici pi√π grandi */
  height:80px;
  background-size: contain;
  background-repeat: no-repeat;
  position:absolute;
}

#info{
  margin-top:10px;
  font-size:22px;
}

button, select{
  padding:10px 25px;
  font-size:18px;
  margin:5px;
}

/* Touch controls pi√π grandi e reattivi */
#controls{
  position:fixed;
  bottom:10px;
  width:100%;
  display:flex;
  justify-content:space-around; /* distanza maggiore tra pulsanti */
  padding: 0 20px;
  gap:30px;
  z-index:1000;
}

.control-btn{
  width:100px;   /* pulsanti grandi */
  height:100px;
  font-size:36px;
  border-radius:50%;
  background:#333;
  color:white;
  border:none;
  touch-action: none;  /* pi√π reattivo ai tocchi multipli */
  -webkit-tap-highlight-color: transparent;
  user-select: none;
}

/* Mobile responsive */
@media (max-width:600px){
  #info{ font-size:24px; }
  select, button{ font-size:20px; padding:15px 35px; min-width:180px; height:50px; }
}
</style>
</head>
<body>

<h1>üöÄ Mini Chicken Invaders</h1>

<select id="playerName">
  <option value="">Scegli il tuo nome</option>
  <option>Alice</option>
  <option>Bob</option>
  <option>Charlie</option>
  <option>Diana</option>
</select>

<button onclick="startGame()">START</button>

<div id="info">Punteggio: 0</div>
<div id="game"></div>

<div id="controls">
  <button class="control-btn" id="left-btn">‚¨ÖÔ∏è</button>
  <button class="control-btn" id="fire-btn">üî•</button>
  <button class="control-btn" id="right-btn">‚û°Ô∏è</button>
</div>

<script>
const supabaseClient = supabase.createClient(
  "https://xloiaewcuwelufblecxf.supabase.co",
  "sb_publishable_SlM0ePMXPgoJjC47P8o-IQ_w6iEn_OP"
);

let score = 0;
let startTime;
let spawnInterval;
let bullets = [];
let enemies = [];
let currentPlayerName = "";
const TARGET_SCORE = 100;

let player, game;
let moveLeft = false, moveRight = false;

// Array immagini nemici
const enemySprites = [
  'https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/morgan.gif',
  'https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/alien1.png',
  'https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/alien2.png'
];

function startGame(){
  const nameSelect = document.getElementById("playerName");
  currentPlayerName = nameSelect.value;
  if(!currentPlayerName){ alert("Seleziona un nome!"); return; }

  score = 0;
  updateInfo();
  startTime = performance.now();

  nameSelect.disabled = true;
  document.querySelector("button").disabled = true;

  game = document.getElementById("game");
  game.innerHTML = "";

  // crea player con immagine
  player = document.createElement("div");
  player.classList.add("player");
  const img = document.createElement("img");
  img.src = "https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/bugo.gif";
  player.appendChild(img);
  game.appendChild(player);

  // spawn nemici
  spawnInterval = setInterval(spawnEnemy, 700); // pi√π continui

  // movimento player
  requestAnimationFrame(gameLoop);

  // controlli touch
  document.getElementById("left-btn").addEventListener("pointerdown", ()=>moveLeft=true);
  document.getElementById("left-btn").addEventListener("pointerup", ()=>moveLeft=false);
  document.getElementById("right-btn").addEventListener("pointerdown", ()=>moveRight=true);
  document.getElementById("right-btn").addEventListener("pointerup", ()=>moveRight=false);
  document.getElementById("fire-btn").addEventListener("pointerdown", fireBullet);
}

function updateInfo(){
  document.getElementById("info").innerText = `Punteggio: ${score} | Obiettivo: ${TARGET_SCORE}`;
}

// Nemici cadono in posizioni casuali
function spawnEnemy(){
  const enemy = document.createElement("div");
  enemy.classList.add("enemy");

  // immagine casuale
  const sprite = enemySprites[Math.floor(Math.random() * enemySprites.length)];
  enemy.style.backgroundImage = `url('${sprite}')`;

  // posizione casuale X, in alto fuori schermo
  enemy.style.left = Math.random() * (game.clientWidth - 80) + "px";
  enemy.style.top = "-80px";

  game.appendChild(enemy);
  enemies.push(enemy);
}

function fireBullet(){
  const bullet = document.createElement("div");
  bullet.classList.add("bullet");
  bullet.innerText = "üöÄ";

  const playerLeft = parseFloat(player.style.left) || (game.clientWidth/2 - 50);
  bullet.style.left = playerLeft + player.offsetWidth/2 - 18 + "px";

  const playerTop = game.clientHeight - 80 - player.offsetHeight;
  bullet.style.top = playerTop + "px";

  game.appendChild(bullet);
  bullets.push(bullet);
}

function gameLoop(){
  const step = 10; // player pi√π veloce
  let left = parseFloat(player.style.left) || (game.clientWidth/2 - 50);
  if(moveLeft) left -= step;
  if(moveRight) left += step;
  left = Math.max(0, Math.min(game.clientWidth - player.offsetWidth, left));
  player.style.left = left + "px";

  // Nemici
  enemies.forEach((enemy, i) => {
    let top = parseFloat(enemy.style.top);
    enemy.style.top = top + 5 + "px"; // pi√π veloci

    // Collisione con il player
    const eRect = enemy.getBoundingClientRect();
    const pRect = player.getBoundingClientRect();
    if(!(eRect.right < pRect.left || eRect.left > pRect.right || eRect.bottom < pRect.top || eRect.top > pRect.bottom)){
        score -= 15; // malus se nemico tocca player
        updateInfo();
        enemy.remove();
        enemies.splice(i, 1);
    }
  });

  // Proiettili
  bullets.forEach((bullet, i) => {
    let top = parseFloat(bullet.style.top);
    bullet.style.top = top - 15 + "px";

    // Collisione con nemici
    enemies.forEach((enemy, j) => {
      const eRect = enemy.getBoundingClientRect();
      const bRect = bullet.getBoundingClientRect();
      if(!(bRect.right < eRect.left || bRect.left > eRect.right || bRect.bottom < eRect.top || bRect.top > eRect.bottom)){
          score += 10; // punti per missile
          updateInfo();
          enemy.remove();
          bullet.remove();
          enemies.splice(j, 1);
          bullets.splice(i, 1);
      }
    });

    if(top < -20){
      bullet.remove();
      bullets.splice(i, 1);
    }
  });

  // Aumenta difficolt√† oltre 70 punti
  if(score >= 70){
    clearInterval(spawnInterval);
    spawnInterval = setInterval(spawnEnemy, 400);
  }

  if(score >= TARGET_SCORE){
    endGame();
    return;
  }

  requestAnimationFrame(gameLoop);
}

async function endGame(){
  clearInterval(spawnInterval);
  const timeElapsed = (performance.now() - startTime)/1000;

  await supabaseClient.from("invaders").insert({
    name: currentPlayerName,
    time: timeElapsed
  });

  alert(`Fine! Hai impiegato ${timeElapsed.toFixed(2)} secondi ü´∂üèª`);

  const nameSelect = document.getElementById("playerName");
  nameSelect.disabled = false;
  document.querySelector("button").disabled = false;

  game.innerHTML = "";
  bullets = [];
  enemies = [];
  updateInfo();
}
</script>

</body>
</html>
