<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Memory Game</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#111;
  color:white;
  text-align:center;
}

h1{ margin:10px; }

#topBar{
  margin:10px;
}

select, button{
  padding:8px 15px;
  font-size:16px;
  border:none;
  border-radius:6px;
  margin:5px;
  cursor:pointer;
}

#info{
  margin:10px;
  font-size:18px;
}

#resetBtn{
  display:none;
}

#game{
  width:95vw;
  max-width:600px;
  margin:20px auto;
  display:none;
  gap:8px;
}

.card{
  position:relative;
  width:100%;
  padding-top:100%;
  perspective:1000px;
}

.inner{
  position:absolute;
  width:100%;
  height:100%;
  transition:transform 0.4s ease;
  transform-style:preserve-3d;
}

.card.flip .inner{
  transform:rotateY(180deg);
}

.front, .back{
  position:absolute;
  width:100%;
  height:100%;
  border-radius:10px;
  backface-visibility:hidden;
}

.front{
  background:#444;
}

.back{
  transform:rotateY(180deg);
  background-size:cover;
  background-position:center;
}
</style>
</head>

<body>

<h1>ðŸ§  Memory Challenge</h1>

<div id="topBar">
  <select id="playerSelect">
    <option>Caricamento...</option>
  </select>
  <button id="startBtn">START</button>
  <button id="resetBtn">RESET</button>
</div>

<div id="info">Livello: 1 | Tempo: 0s</div>
<div id="game"></div>

<script>
const supabaseClient = supabase.createClient(
  "https://xloiaewcuwelufblecxf.supabase.co",
  "sb_publishable_SlM0ePMXPgoJjC47P8o-IQ_w6iEn_OP"
);

const game=document.getElementById("game");
const info=document.getElementById("info");
const resetBtn=document.getElementById("resetBtn");

let currentPlayerId=null;
let currentPlayerName="";
let level=1;
let flippedCards=[];
let matchedPairs=0;
let startTime;
let timerInterval;
let lockBoard=false;

const levels=[4,6,8];

const images=Array.from({length:32}, (_,i)=>`https://picsum.photos/200?random=${i}`);

/* ===== SHUFFLE CORRETTO ===== */
function shuffle(array){
  for(let i=array.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [array[i],array[j]]=[array[j],array[i]];
  }
  return array;
}

/* ===== LOAD PLAYERS ===== */
async function loadPlayers(){
  const {data,error}=await supabaseClient
    .from("players")
    .select("id, player")
    .is("memory", null);

  const select=document.getElementById("playerSelect");
  select.innerHTML='<option value="">Scegli nome</option>';

  if(error){
    select.innerHTML='<option>Errore caricamento</option>';
    return;
  }

  data.forEach(p=>{
    const option=document.createElement("option");
    option.value=p.id;
    option.textContent=p.player;
    select.appendChild(option);
  });
}

loadPlayers();

/* ===== START ===== */
document.getElementById("startBtn").addEventListener("click", async ()=>{
  const select=document.getElementById("playerSelect");
  currentPlayerId=select.value;

  if(!currentPlayerId){
    alert("Seleziona un nome");
    return;
  }

  const {data}=await supabaseClient
    .from("players")
    .select("player")
    .eq("id",currentPlayerId)
    .single();

  currentPlayerName=data.player;

  await supabaseClient
    .from("players")
    .update({ memory:new Date().toISOString() })
    .eq("id",currentPlayerId);

  select.style.display="none";
  document.getElementById("startBtn").style.display="none";
  resetBtn.style.display="inline-block";
  game.style.display="grid";

  startGame();
});

/* ===== CREA BOARD ===== */
function createBoard(){
  const size=levels[level-1];
  const totalCards=size*size;
  const totalPairs=totalCards/2;

  game.style.gridTemplateColumns=`repeat(${size},1fr)`;
  game.innerHTML="";

  flippedCards=[];
  matchedPairs=0;
  lockBoard=false;

  const selected=images.slice(0,totalPairs);
  const cards=shuffle([...selected,...selected]);

  cards.forEach(img=>{
    const card=document.createElement("div");
    card.className="card";
    card.dataset.image=img;

    card.innerHTML=`
      <div class="inner">
        <div class="front"></div>
        <div class="back" style="background-image:url('${img}')"></div>
      </div>`;

    card.addEventListener("click", handleCardClick);

    game.appendChild(card);
  });
}

/* ===== CLICK SICURO ===== */
function handleCardClick(e){
  const card=e.currentTarget;

  if(lockBoard) return;
  if(card.classList.contains("flip")) return;

  card.classList.add("flip");
  flippedCards.push(card);

  if(flippedCards.length===2){
    checkMatch();
  }
}

function checkMatch(){
  lockBoard=true;

  const [card1,card2]=flippedCards;
  const isMatch=card1.dataset.image===card2.dataset.image;

  if(isMatch){
    matchedPairs++;
    flippedCards=[];
    lockBoard=false;
    checkLevelComplete();
  }else{
    setTimeout(()=>{
      card1.classList.remove("flip");
      card2.classList.remove("flip");
      flippedCards=[];
      lockBoard=false;
    },700);
  }
}

/* ===== LIVELLO COMPLETATO ===== */
async function checkLevelComplete(){
  const size=levels[level-1];

  if(matchedPairs === (size*size)/2){
    level++;

    if(level>levels.length){
      clearInterval(timerInterval);
      const totalTime=Math.floor((Date.now()-startTime)/1000);

      await supabaseClient.from("memorySing").insert({
        name:currentPlayerName,
        time:totalTime
      });

      alert("Completato! Tempo: "+totalTime+"s");
      location.reload();
      return;
    }

    createBoard();
  }
}

/* ===== TIMER ===== */
function updateTimer(){
  const time=Math.floor((Date.now()-startTime)/1000);
  info.innerText=`Livello: ${level} | Tempo: ${time}s`;
}

function startGame(){
  startTime=Date.now();
  timerInterval=setInterval(updateTimer,1000);
  createBoard();
}

/* ===== RESET ===== */
resetBtn.addEventListener("click", ()=>{
  level=1;
  clearInterval(timerInterval);
  startGame();
});
</script>

</body>
</html>
